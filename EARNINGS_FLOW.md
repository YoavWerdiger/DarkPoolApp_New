# 🔄 תרשים זרימה - מערכת דיווחי תוצאות

## 📅 ציר זמן יומי

```
00:00 ─────────────────────────────────────────────────────────────────
      │
01:30 │  🌄 earnings-results-morning (04:30 Israel Time)
      │  └─ עדכון תוצאות BeforeMarket
      │     • WFC, JPM, C וכו'
      │     • עדכון actual + percent
      │
03:00 │  🌅 earnings-daily-sync (06:00 Israel Time)
      │  └─ סנכרון יומי ראשי
      │     • משיכת 30 יום קדימה
      │     • ~70 מניות
      │     • כל הדיווחים המתוכננים
      │
      │  [השווקים פתוחים - ארה"ב]
      │
20:00 │  🌙 earnings-results-evening (23:00 Israel Time)
      │  └─ עדכון תוצאות AfterMarket
      │     • NFLX, TSLA, META וכו'
      │     • עדכון actual + percent
      │
23:59 ─────────────────────────────────────────────────────────────────
```

---

## 🏗️ ארכיטקטורה

```
┌─────────────────────────────────────────────────────────────┐
│                      EODHD API                               │
│              (מקור הנתונים - עדכון real-time)               │
└────────────────────┬────────────────────────────────────────┘
                     │
        ┌────────────┴────────────┐
        │                         │
        ▼                         ▼
┌──────────────────┐    ┌──────────────────────┐
│ earnings-daily-  │    │ earnings-results-    │
│ sync             │    │ update               │
│                  │    │                      │
│ • רץ 1x/day      │    │ • רץ 2x/day          │
│ • 30 יום קדימה   │    │ • 3 ימים אחורה       │
│ • דיווחים חדשים  │    │ • עדכון תוצאות      │
└────────┬─────────┘    └─────────┬────────────┘
         │                        │
         └────────┬───────────────┘
                  ▼
    ┌──────────────────────────┐
    │  earnings_calendar        │
    │  (Supabase Table)        │
    │                          │
    │  • id                    │
    │  • code                  │
    │  • report_date           │
    │  • estimate              │
    │  • actual                │
    │  • percent               │
    │  • before_after_market   │
    └────────────┬─────────────┘
                 │
                 ▼
    ┌──────────────────────────┐
    │  React Native App        │
    │  EarningsReportsTab      │
    │                          │
    │  📱 תצוגה למשתמש:        │
    │  • לפני פתיחה ☀️         │
    │  • אחרי סגירה 🌙         │
    │  • תוצאות בזמן אמת       │
    └──────────────────────────┘
```

---

## 🔄 זרימת נתונים - דוגמה

### יום רגיל (למשל 14 אוקטובר):

```
03:00 UTC (06:00 Israel)
├─ earnings-daily-sync רץ
├─ שולף מ-EODHD:
│  ├─ 14.10 - היום
│  ├─ 15.10 - מחר
│  ├─ ... 
│  └─ 13.11 - בעוד 30 יום
│
└─ מכניס/מעדכן ב-DB:
   ├─ JPM.US - 14.10 - BeforeMarket - estimate: 4.87
   ├─ WFC.US - 14.10 - BeforeMarket - estimate: 1.55
   ├─ AAPL.US - 15.10 - AfterMarket - estimate: 1.52
   └─ ... (עוד מאות דיווחים)

📱 משתמשים רואים:
   "JPM - תחזית: $4.87 - לפני פתיחה ☀️"

───────────────────────────────────────────────

01:30 UTC (04:30 Israel) - אחרי דיווחי BeforeMarket
├─ earnings-results-update רץ
├─ שולף מ-EODHD (3 ימים אחורה):
│  ├─ JPM.US - actual: 5.10 (+4.7%)
│  └─ WFC.US - actual: 1.62 (+4.5%)
│
└─ מעדכן ב-DB:
   ├─ JPM.US - actual: 5.10, percent: 4.7
   └─ WFC.US - actual: 1.62, percent: 4.5

📱 משתמשים רואים:
   "JPM - רווחיות: $5.10 (+4.7%) 🟢"

───────────────────────────────────────────────

20:00 UTC (23:00 Israel) - אחרי דיווחי AfterMarket
├─ earnings-results-update רץ (שוב)
├─ שולף מ-EODHD:
│  ├─ NFLX.US - actual: 3.73 (+8.2%)
│  └─ TSLA.US - actual: 0.62 (-3.1%)
│
└─ מעדכן ב-DB:
   ├─ NFLX.US - actual: 3.73, percent: 8.2
   └─ TSLA.US - actual: 0.62, percent: -3.1

📱 משתמשים רואים:
   "NFLX - רווחיות: $3.73 (+8.2%) 🟢"
   "TSLA - רווחיות: $0.62 (-3.1%) 🔴"
```

---

## 🎯 מצבי תצוגה

### מצב 1: לפני דיווח (יש רק estimate)
```typescript
{
  code: "AAPL.US",
  report_date: "2025-10-15",
  estimate: 1.52,
  actual: null,
  percent: null,
  before_after_market: "AfterMarket"
}
```
**תצוגה:**
```
┌─────────────────────────────────┐
│ [🍎] AAPL           Q3 2025    │
│                                 │
│ 🌙 אחרי סגירה                  │
│                                 │
│ תחזית רווחיות: $1.52           │
│ תחזית הכנסות: $89.5B           │
└─────────────────────────────────┘
```

### מצב 2: אחרי דיווח (יש actual)
```typescript
{
  code: "AAPL.US",
  report_date: "2025-10-15",
  estimate: 1.52,
  actual: 1.64,
  percent: 7.9,
  before_after_market: "AfterMarket"
}
```
**תצוגה:**
```
┌─────────────────────────────────┐
│ [🍎] AAPL           Q3 2025    │
│                                 │
│ 🌙 אחרי סגירה                  │
│                                 │
│ רווחיות: $1.64 🟢               │
│ הכנסות: $95.3B                 │
│                                 │
│ ┌─────────────────────────────┐ │
│ │      +7.9% 🟢               │ │
│ └─────────────────────────────┘ │
└─────────────────────────────────┘
```

---

## 📊 סטטיסטיקות

**כמות דיווחים ממוצעת:**
- ~40 BeforeMarket ביום
- ~48 AfterMarket ביום
- ~88 דיווחים סה"כ ביום

**כמות דיווחים ב-DB:**
- יום אחד: ~88
- שבוע: ~440
- חודש: ~2,640

**Cron Jobs:**
- 3 jobs פעילים
- 3 ריצות ביום
- 90 ריצות בחודש

---

## ✅ סיכום

המערכת פשוטה, יעילה ואמינה:

✅ **2 פונקציות בלבד**
✅ **3 Cron Jobs**
✅ **עדכון אוטומטי 3 פעמים ביום**
✅ **תצוגה real-time למשתמשים**

